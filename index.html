<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viento & Pichuchis ‚ù§Ô∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Dancing+Script:wght@700&family=Pacifico&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --pink: #fb6f92; --soft: #fff0f3; --dark-pink: #ff4d6d; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }
        
        body { 
            background: #050505; 
            overflow: hidden; 
            height: 100vh; 
            color: white;
        }

        .snoopy-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://w0.peakpx.com/wallpaper/599/238/HD-wallpaper-snoopy-love-dog-heart-pink-thumbnail.jpg');
            background-size: cover; background-position: center; z-index: -1;
        }

        #windCanvas { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }

        nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 50px; display: flex; gap: 15px; z-index: 100;
            border: 1px solid rgba(251, 111, 146, 0.5);
        }
        nav button { background: none; border: none; color: white; font-weight: 700; cursor: pointer; font-size: 0.7rem; transition: 0.3s; }
        nav button:hover { color: var(--pink); text-shadow: 0 0 10px var(--pink); }

        .page {
            position: absolute; width: 100%; height: 100vh; z-index: 10;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .page.active { display: flex; animation: fade 0.8s ease; }

        .lyrics-container { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: var(--pink); min-height: 150px; text-shadow: 0 0 15px rgba(251,111,146,0.5); }
        
        .timer { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; border: 1px solid var(--pink); backdrop-filter: blur(5px); margin-bottom: 20px; }
        .grid { display: flex; gap: 15px; }
        .num { font-size: 1.8rem; font-weight: 700; color: var(--pink); }
        .label { font-size: 0.6rem; color: #ccc; }

        .msg-box { background: rgba(255,255,255,0.1); border: 1px solid var(--pink); padding: 15px; border-radius: 15px; width: 300px; margin-top: 20px; }
        textarea { width: 100%; background: transparent; border: none; color: white; resize: none; border-bottom: 1px solid var(--pink); margin-bottom: 10px; padding: 5px; outline: none; }
        
        .polaroid { 
            background: white; padding: 8px 8px 25px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            width: 130px; transform: rotate(var(--r)); margin: 10px; color: #333;
            transition: transform 0.3s;
        }
        .polaroid:hover { transform: scale(1.1) rotate(0deg) !important; z-index: 50; }
        .polaroid img { width: 100%; height: 110px; object-fit: cover; }

        .btn { background: var(--pink); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 700; }
        .btn:disabled { background: #555; cursor: wait; }

        @keyframes fade { from { opacity: 0; filter: blur(10px); } to { opacity: 1; filter: blur(0); } }
        .heart { position: absolute; pointer-events: none; animation: floatUp 1.5s forwards; z-index: 1000; }
        @keyframes floatUp { to { transform: translateY(-100px) scale(0); opacity: 0; } }
    </style>
</head>
<body onclick="createHeart(event.clientX, event.clientY)">

    <div class="snoopy-bg"></div>
    <canvas id="windCanvas"></canvas>

    <nav>
        <button onclick="show(0)">INICIO</button>
        <button onclick="show(1)">√ÅLBUM</button>
        <button onclick="show(2)">DEDICATORIA</button>
        <button onclick="show(3)">M√öSICA</button>
    </nav>

    <div class="page active" id="p0">
        <h1 style="font-family:'Cinzel'; letter-spacing: 10px; font-size: 3rem; margin-bottom: 10px;">TE AMO PICHUCHIS</h1>
        <div class="timer">
            <div class="grid">
                <div><span class="num" id="d">0</span><br><span class="label">D√çAS</span></div>
                <div><span class="num" id="h">0</span><br><span class="label">HRS</span></div>
                <div><span class="num" id="m">0</span><br><span class="label">MIN</span></div>
                <div><span class="num" id="s">0</span><br><span class="label">SEG</span></div>
            </div>
        </div>
        <div class="lyrics-container" id="lyrics-display">Cargando magia...</div>
    </div>

    <div class="page" id="p1">
        <h2 style="font-family:'Pacifico'; color:var(--pink);">Nuestros Recuerdos</h2>
        <button class="btn" id="btn-foto" onclick="document.getElementById('p-in').click()">SUBIR FOTO üì∏</button>
        <input type="file" id="p-in" accept="image/*" style="display:none">
        <p id="status-foto" style="font-size: 0.7rem; margin-top: 5px; opacity: 0.8;"></p>
        <div id="album" style="display: flex; flex-wrap: wrap; justify-content: center; overflow-y: auto; max-height: 60vh; width: 100%;"></div>
    </div>

    <div class="page" id="p2">
        <h2 style="font-family:'Pacifico'; color:var(--pink);">Nuestra Dedicatoria</h2>
        <div class="msg-box">
            <textarea id="msg-input" placeholder="Escribe algo cursi aqu√≠..." rows="3"></textarea>
            <button class="btn" id="send-msg">GUARDAR MENSAJE ‚ù§Ô∏è</button>
        </div>
        <div id="messages-stream" style="margin-top:20px; font-family:'Dancing Script'; font-size: 1.8rem; color: #ffccd5; max-width: 80%;"></div>
    </div>

    <div class="page" id="p3">
        <h2 style="font-family:'Pacifico'; color:var(--pink);">Playlist</h2>
        <audio id="player" controls style="margin:20px; width:80%;"></audio>
        <button class="btn" onclick="document.getElementById('m-in').click()">CARGAR CANCI√ìN üéµ</button>
        <input type="file" id="m-in" accept="audio/*" style="display:none">
        <p style="font-size:0.7rem; margin-top:5px; opacity:0.7;">(Sube archivos mp3, ten paciencia al cargar)</p>
        <div id="songs" style="background: rgba(255,255,255,0.1); width: 300px; border-radius: 15px; max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
    </div>

    <script type="module">
        // Importamos Firebase desde el CDN oficial (necesario para navegadores sin bundler)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js";

        // --- TU CONFIGURACI√ìN DE FIREBASE NUEVA ---
        const firebaseConfig = {
            apiKey: "AIzaSyC7GbaOLgEUI3r7tPCJlOl4qGltk3pcFMs",
            authDomain: "nuestra-fecha-16-11-2025-5ffe1.firebaseapp.com",
            databaseURL: "https://nuestra-fecha-16-11-2025-5ffe1-default-rtdb.firebaseio.com",
            projectId: "nuestra-fecha-16-11-2025-5ffe1",
            storageBucket: "nuestra-fecha-16-11-2025-5ffe1.firebasestorage.app",
            messagingSenderId: "644385675223",
            appId: "1:644385675223:web:9c1afd713701565eb21d92",
            measurementId: "G-KD7D17EDJ6"
        };

        // INICIALIZAMOS FIREBASE
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);

        // NAVEGACI√ìN
        window.show = (i) => {
            document.querySelectorAll('.page').forEach((p, idx) => p.classList.toggle('active', i === idx));
        };

        // RELOJ
        const start = new Date('2025-11-16T00:00:00').getTime();
        setInterval(() => {
            const diff = Date.now() - start;
            document.getElementById('d').innerText = Math.floor(diff / 86400000);
            document.getElementById('h').innerText = Math.floor((diff / 3600000) % 24).toString().padStart(2,'0');
            document.getElementById('m').innerText = Math.floor((diff / 60000) % 60).toString().padStart(2,'0');
            document.getElementById('s').innerText = Math.floor((diff / 1000) % 60).toString().padStart(2,'0');
        }, 1000);

        // PARTICULAS
        const canv = document.getElementById('windCanvas');
        const ctx = canv.getContext('2d');
        let width, height;
        const resize = () => { width = canv.width = window.innerWidth; height = canv.height = window.innerHeight; };
        window.addEventListener('resize', resize); resize();

        let particles = [];
        const words = ["Noviembre", "2025", "Love", "Pichuchis", "16", "‚ù§Ô∏è"];
        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.vx = Math.random() * 2 + 1; this.vy = Math.random() * 1 - 0.5;
                this.text = words[Math.floor(Math.random()*words.length)];
                this.size = Math.random() * 15 + 10; this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() { this.x += this.vx; this.y += this.vy; if(this.x > width) this.x = -50; }
            draw() { ctx.globalAlpha = this.opacity; ctx.fillStyle = "#fb6f92"; ctx.font = `italic ${this.size}px 'Dancing Script'`; ctx.fillText(this.text, this.x, this.y); }
        }
        for(let i=0; i<45; i++) particles.push(new Particle());
        function animate() { ctx.clearRect(0,0,width,height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        animate();

        // LETRAS
        const lyrics = ["Pr√©stame tu peine", "Y p√©iname el alma", "Desenr√©dame", "Fuera de este mundo", "Viento am√°rranos", "Tiempo detente muchos a√±os"];
        let lyricIdx = 0;
        setInterval(() => {
            const el = document.getElementById('lyrics-display');
            if(!el) return;
            el.style.opacity = 0;
            setTimeout(() => { el.innerText = lyrics[lyricIdx]; el.style.opacity = 1; lyricIdx = (lyricIdx + 1) % lyrics.length; }, 500);
        }, 4000);

        // --- FUNCIONES DE BASE DE DATOS (CON COMPRESI√ìN) ---

        // Funci√≥n m√°gica para comprimir im√°genes antes de subir (Evita errores de tama√±o)
        const resizeImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const max = 800; // Calidad aceptable, tama√±o peque√±o
                        if (w > h) { if (w > max) { h *= max / w; w = max; } } 
                        else { if (h > max) { w *= max / h; h = max; } }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); // Comprimir a JPG 70%
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // 1. SUBIR FOTOS (COMPRIMIDAS)
        document.getElementById('p-in').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const btn = document.getElementById('btn-foto');
            const status = document.getElementById('status-foto');
            
            btn.disabled = true;
            status.innerText = "Comprimiendo y subiendo foto...";

            try {
                // Comprimir
                const compressedBase64 = await resizeImage(file);
                // Guardar en Firebase
                await push(ref(db, 'fotos'), { img: compressedBase64 });
                alert("¬°Foto guardada correctamente!");
            } catch (err) {
                console.error(err);
                alert("Error al subir. Aseg√∫rate de haber habilitado las Reglas en Firebase.");
            } finally {
                btn.disabled = false;
                status.innerText = "";
            }
        };

        // Leer fotos
        onChildAdded(ref(db, 'fotos'), (snap) => {
            const div = document.createElement('div'); div.className = 'polaroid';
            div.style.setProperty('--r', (Math.random()*10-5)+'deg');
            div.innerHTML = `<img src="${snap.val().img}"><p style="font-size:0.7rem; text-align:center;">Pichuchis ‚ù§Ô∏è</p>`;
            document.getElementById('album').prepend(div);
        });

        // 2. SUBIR MENSAJES
        document.getElementById('send-msg').onclick = () => {
            const val = document.getElementById('msg-input').value;
            if(val) {
                push(ref(db, 'mensajes'), { text: val });
                document.getElementById('msg-input').value = '';
                createHeart(window.innerWidth/2, window.innerHeight/2);
            }
        };

        onChildAdded(ref(db, 'mensajes'), (snap) => {
            const stream = document.getElementById('messages-stream');
            stream.innerText = `"${snap.val().text}"`;
            stream.animate([{opacity:0, filter:'blur(5px)'}, {opacity:1, filter:'blur(0)'}], 1000);
        });

        // 3. SUBIR M√öSICA
        // Nota: Subimos el archivo directo a la BD. Si es muy pesado (>5MB) puede fallar.
        document.getElementById('m-in').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            alert("Subiendo canci√≥n... Esto puede tardar unos segundos. Por favor espera.");
            const reader = new FileReader();
            reader.onload = (ev) => {
                push(ref(db, 'musica'), { name: file.name, src: ev.target.result })
                    .then(() => alert("¬°Canci√≥n agregada!"))
                    .catch(() => alert("La canci√≥n es demasiado pesada para la base de datos gratuita. Intenta con una m√°s corta o de menor calidad."));
            };
            reader.readAsDataURL(file);
        };

        const player = document.getElementById('player');
        onChildAdded(ref(db, 'musica'), (snap) => {
            const d = document.createElement('div'); d.style.padding = "10px"; d.style.cursor = "pointer";
            d.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            d.innerText = "üéµ " + snap.val().name;
            d.onclick = () => { player.src = snap.val().src; player.play(); };
            document.getElementById('songs').prepend(d);
        });

        // EFECTOS
        window.createHeart = (x, y) => {
            const h = document.createElement('div'); h.className = 'heart';
            h.innerHTML = '‚ù§Ô∏è'; h.style.left = x+'px'; h.style.top = y+'px';
            h.style.fontSize = Math.random()*20+15+'px'; document.body.appendChild(h);
            setTimeout(() => h.remove(), 1500);
        };
    </script>
</body>
</html>
